//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching clone
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION clone_spell
    STR_VAR
           spell_old=""
           spell_new=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION clone_template 
                  STR_VAR file_old=EVALUATE_BUFFER ~%spell_old%~
                          file_new=EVALUATE_BUFFER ~%spell_new%~
                          file_ending=~SPL~
                          edits=EVALUATE_BUFFER ~%edits%~
                          editstring=EVALUATE_BUFFER ~%editstring%~
         END
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching edit
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION edit_spell
    STR_VAR
           spell=""
           edits=""
           editstring=""
    BEGIN
        LAUNCH_ACTION_FUNCTION clone_spell STR_VAR spell_old = EVALUATE_BUFFER ~%spell%~ spell_new = EVALUATE_BUFFER ~%spell%~ edits=EVALUATE_BUFFER ~%edits%~ editstring=EVALUATE_BUFFER ~%editstring%~ END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               simple data-field edits - relative to effects
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

ACTION_DEFINE_ASSOCIATIVE_ARRAY eff_fields BEGIN
   opcode=>~0,SHORT~
   power=>~0x3,BYTE~
END

LAUNCH_ACTION_FUNCTION build_simple_data_field_editors STR_VAR lookup_table=eff_fields offset_base=~offset_base~ function_prefix=SPL END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               swap opcodes
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_PATCH_FUNCTION swap_opcode_base
     STR_VAR opcode_old=""
             opcode_new=""
             offset_base=""
BEGIN
    LAUNCH_PATCH_FUNCTION ~SPL_read_opcode~ RET oldvalue=value END
    PATCH_IF oldvalue=opcode_old BEGIN
             LAUNCH_PATCH_FUNCTION ~SPL_opcode~ STR_VAR arguments=EVALUATE_BUFFER ~%opcode_new%~ END
    END
END

DEFINE_PATCH_FUNCTION SPL_swap_opcodes
   STR_VAR  arguments=""
BEGIN
   SPRINT ~instruction~ ~LAUNCH_PATCH_FUNCTION walk_effect_tree STR_VAR instruction="sec_instruction" END~
   SPRINT ~sec_instruction~ ~LAUNCH_PATCH_FUNCTION swap_opcode_base STR_VAR opcode_old=<key> opcode_new=<value> offset_base=<offset_base> END~
   LAUNCH_PATCH_FUNCTION process_csv_of_arrows
            STR_VAR input=EVALUATE_BUFFER ~%arguments%~ 
                    instruction=~EVALUATE_BUFFER ~%instruction%~
                    instruction2=~EVALUATE_BUFFER ~%instruction2%~
   END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               change power of all opcodes
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


DEFINE_PATCH_FUNCTION SPL_power_all
   STR_VAR  arguments=""
BEGIN
   LAUNCH_PATCH_FUNCTION walk_effect_tree
            STR_VAR instruction=EVALUATE_BUFFER "SPL_power(arguments=%arguments%,offset_base=<offset_base>)"
   END
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////              delete effects
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_PATCH_FUNCTION SPL_delete_opcodes
     STR_VAR arguments=""
BEGIN
                LAUNCH_PATCH_FUNCTION process_csv_instruction
                         STR_VAR input=EVALUATE_BUFFER ~%%arguments%%~
                                 instruction=~LAUNCH_PATCH_FUNCTION DELETE_SPELL_EFFECT STR_VAR opcode_to_delete=<argument> END~
                END

END
