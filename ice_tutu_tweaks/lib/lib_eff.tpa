//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching clone
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION clone_effect
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION clone_template
                  STR_VAR file_list=EVALUATE_BUFFER ~%effect%~
                          file_prefix=~EFF~
                          edits=EVALUATE_BUFFER ~%edits%~
                          editstring=EVALUATE_BUFFER ~%editstring%~
         END
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching edit
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION edit_effect
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION edit_template
                  STR_VAR file_list=EVALUATE_BUFFER ~%effect%~
                          file_prefix=~EFF~
                          edits=EVALUATE_BUFFER ~%edits%~
                          editstring=EVALUATE_BUFFER ~%editstring%~
         END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               overarching make
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION make_effect
    STR_VAR
           effect=""
           edits=""
           editstring=""
    BEGIN
         LAUNCH_ACTION_FUNCTION make_template
                  STR_VAR file_list=EVALUATE_BUFFER ~%effect%~
                          file_prefix=~EFF~
                          edits=EVALUATE_BUFFER ~%edits%~
                          editstring=EVALUATE_BUFFER ~%editstring%~
                          build_before= EFF_build
         END
END

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////               simple data-field edits
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

ACTION_DEFINE_ASSOCIATIVE_ARRAY eff_fields BEGIN
   opcode => ~0x10,LONG~
   target => ~0x14,LONG~
   power => ~0x18,LONG~
   parameter1=>~0x1c,LONG~
   parameter2=>~0x20,LONG~
   timing=>~0x24,SHORT~
   duration=>~0x28,LONG~
   probability1_min=>~0x2c,BYTE~
   probability1_max=>~0x2d,BYTE~
   probability2_min=>~0x2e,BYTE~
   probability2_max=>~0x2f,BYTE~
   resource=>~0x30,ASCII~
   dicenum=>~0x38,LONG~
   dicesize=>~0x3c,LONG~
   savebonus=>~0x44,LONG~
   resistance=>~0x5c,LONG~
   vvc=>~0x70,ASCII~
   
   //many others; I'll stop there
END

LAUNCH_ACTION_FUNCTION build_simple_data_field_editors STR_VAR lookup_table=eff_fields function_prefix=EFF END


ACTION_DEFINE_ASSOCIATIVE_ARRAY eff_bit_fields BEGIN
      save_spells=>~0x40,0~
      save_breath=>~0x40,1~
      save_death=>~0x40,2~
      save_wands=>~0x40,3~
      save_polymorph=>~0x40,4~
      bypass_mirror_image=>~0x43,0~
END

LAF build_flag_data_field_editors STR_VAR lookup_table=eff_bit_fields function_prefix=EFF END



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////// build a basic effect
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_PATCH_FUNCTION EFF_build
BEGIN
   ///// basic structure
   DELETE_BYTES 0x0 BUFFER_LENGTH
   INSERT_BYTES 0x0 0x110

   // sig
   WRITE_ASCII 0x0 ~EFF V2.0~
   WRITE_ASCII 0x8 ~EFF V2.0~
   // start off with probability 100
   WRITE_BYTE 0x2c 100
   // unknown fields, copied blindly from example file
   WRITE_LONG 0x80 0xffffffff
   WRITE_LONG 0x84 0xffffffff
   WRITE_LONG 0x88 0xffffffff
   WRITE_LONG 0x8c 0xffffffff
   WRITE_LONG 0xa4 0xffffffff
END


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////// make an effect that casts a spell
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DEFINE_ACTION_FUNCTION make_casting_effect
    INT_VAR target=2
    STR_VAR effect=""
            spell=""
BEGIN
   ACTION_CLEAR_ARRAY patch_data
   ACTION_DEFINE_ASSOCIATIVE_ARRAY patch_data BEGIN
       opcode=>146
       target=>~%target%~
       parameter2=>1
       timing=>1
       parameter1=>1
       resource=>~%spell%~
   END
   LAF make_effect STR_VAR effect edits=patch_data END



END
